rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIÓN AUXILIAR PARA VER SI EL USUARIO ES ADMIN ---
   function isAdmin() {
      return exists(/databases/$(database)/documents/users_admin/$(request.auth.uid)) ||
             (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
   match /users_admin/{userId} {
      allow create: if request.auth != null; // Cualquiera logueado puede crear su perfil admin inicial
      allow read, write: if request.auth != null && request.auth.uid == userId; // Solo el propio admin toca sus datos
    }
     match /planes_subscripcion/{planId} {
      // Permitimos leer a cualquier usuario logueado (para que puedan ver la oferta)
      allow read, list: if request.auth != null;
      
      // SOLO el administrador puede crear, editar o eliminar planes
      allow write: if isAdmin();
    }

    // ==========================================================
    // 1. REGLAS INDIVIDUALES (Modo Individual)
    // ==========================================================
    
    match /users/{userId} {
      // Permitir crear usuarios (registro)
      allow create: if request.auth != null;
      
      // Permitir leer (puedes restringirlo luego, pero para el admin dashboard es necesario)
      allow read: if request.auth != null;
      
      // Permitir actualizar si: es el propio usuario O SI es admin
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Permitir borrar SOLO si es admin
      allow delete: if isAdmin();
      
      match /customCategories/{categoryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /incomeCategories/{categoryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /expenses/{expenseId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /notifications/{notificationId} {
        allow read, update: if request.auth.uid == userId;
        allow create: if request.auth != null;
        allow delete: if false;
      }
    }

    // --- COLECCIÓN 'gastos' (Aquí es donde BudgetService.ts escribe en modo individual) ---
    // CORRECCIÓN APLICADA: Separamos 'create' de 'read/update/delete'
    match /gastos/{gastoId} {
      // Al CREAR: Verificamos los datos que ENTRAN (request.resource.data)
      allow create: if request.auth != null && request.resource.data.creado_por == request.auth.uid;
      
      // Al LEER/EDITAR/BORRAR: Verificamos los datos que YA EXISTEN (resource.data)
      allow read, update, delete: if request.auth != null && resource.data.creado_por == request.auth.uid;
    }
    
    // Colección 'expenses' (Por si acaso tienes lógica antigua)
    match /expenses/{expenseId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    match /ingresos/{ingresoId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    match /planes_presupuestarios/{planId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.creado_por;
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.creado_por;
    }
    
    match /notifications/{notificationId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    // ==========================================================
    // 2. REGLAS GRUPALES (Modo Grupo)
    // ==========================================================
    match /groups/{groupId} {
      
      function isGroupMember() {
        return request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.memberUIDs;
      }
      function isGroupAdmin() {
        let groupData = get(/databases/$(database)/documents/groups/$(groupId)).data;
        return request.auth.uid in groupData.members && groupData.members[request.auth.uid].role == 'admin';
      }

      allow get: if request.auth != null && (isGroupMember() || request.auth.token.email in resource.data.pendingInvitations);
      allow list: if request.auth != null;
      allow update: if isGroupMember();
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;
      allow create: if request.auth != null;
      
      // --- Subcolecciones ---
      
      match /budget_plans/{planId} {
        allow read: if isGroupMember();
        allow create: if isGroupMember();
        // Permitir update a miembros para que puedan marcar el checkbox
        allow update: if isGroupMember();
        allow delete: if isGroupAdmin();
      }

      match /expenses/{expenseId} {
        allow read, create, update, delete: if isGroupMember();
      }

      match /incomes/{incomeId} {
        allow read, create, update, delete: if isGroupMember();
      }
    }
  }
}